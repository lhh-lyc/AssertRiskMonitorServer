<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.lhh.serverinfocommon.dao.scan.ScanHostDao">

    <sql id="baseColumn">
                    id,
                    project_id,
                    host,
                    domain_name,
                    parent_id,
                    create_time,
                    update_time,
                    del_flg,
                    create_id,
                    update_id
            </sql>

    <!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="com.lhh.serverbase.entity.ScanHostEntity" id="scanHostMap">
                    <result property="hostId" column="host_id"/>
                    <result property="domain" column="domain"/>
                    <result property="parentDomain" column="parent_domain"/>
                    <result property="ip" column="ip"/>
                    <result property="createTime" column="create_time"/>
                    <result property="updateTime" column="update_time"/>
                    <result property="delFlg" column="del_flg"/>
                    <result property="createId" column="create_id"/>
                    <result property="updateId" column="update_id"/>
            </resultMap>

    <select id="queryDomainGroupList" resultType="com.lhh.serverbase.dto.ScanResultDto">
        select
        t3.id as project_id,t1.parent_domain, t1.domain, t1.company,t1.ip, t1.is_domain, t1.is_major
        from scan_host t1
        left join scan_project_host t2 on t2.`host` = t1.domain
        and t2.del_flg = 0
        left join scan_project t3 on t3.id = t2.project_id
        and t3.del_flg = 0
        where t1.del_flg = 0
        <if test="userId != null and userId != ''">
            and t3.user_id = #{userId}
        </if>
        GROUP BY t1.domain
    </select>

    <select id="getCompanyNum" resultType="java.lang.Integer">
        SELECT
        count(DISTINCT t1.company)
        FROM
        scan_host t1
        LEFT JOIN scan_project_host t2 ON t2.`host` = t1.domain
        AND t2.del_flg = 0
        LEFT JOIN scan_project t3 ON t3.id = t2.project_id
        AND t3.del_flg = 0
        WHERE
        t1.del_flg = 0
        <if test="userId != null and userId != ''">
            and t3.user_id = #{userId}
        </if>
    </select>

    <select id="getDomainNum" resultType="java.lang.Integer">
        SELECT
        count(distinct domain)
        FROM
        scan_host t1
        LEFT JOIN scan_project_host t2 ON t2.`host` = t1.domain
        AND t2.del_flg = 0
        LEFT JOIN scan_project t3 ON t3.id = t2.project_id
        AND t3.del_flg = 0
        WHERE
        t1.del_flg = 0
        and t1.is_major = 1
        <if test="userId != null and userId != ''">
            and t3.user_id = #{userId}
        </if>
    </select>

    <select id="getSubDomainNum" resultType="java.lang.Integer">
        SELECT
        count(distinct domain)
        FROM
        scan_host t1
        LEFT JOIN scan_project_host t2 ON t2.`host` = t1.domain
        AND t2.del_flg = 0
        LEFT JOIN scan_project t3 ON t3.id = t2.project_id
        AND t3.del_flg = 0
        WHERE
        t1.del_flg = 0
        and t1.is_domain = 1
        and t1.is_major = 0
        <if test="userId != null and userId != ''">
            and t3.user_id = #{userId}
        </if>
    </select>

    <select id="companyRanking" resultType="com.lhh.serverbase.dto.KeyValueDto">
        SELECT t1.company as type,
        <if test='type == "1"'>
            COUNT(DISTINCT t1.parent_domain)
        </if>
        <if test='type == "2"'>
            COUNT(DISTINCT t1.domain)
        </if>
        <if test='type == "3"'>
            COUNT(DISTINCT t1.ip)
        </if>
        <if test='type == "4"'>
            COUNT( DISTINCT t4.ip, t4.port )
        </if> as value
        FROM scan_host t1
        join scan_project_content t2 on t2.parent_domain = t1.parent_domain
        and t2.del_flg = 0
        join scan_project t3 on t3.id = t2.project_id
        and t3.del_flg = 0
        <if test='type == "4"'>
            join scan_port t4 on t4.ip = t1.ip
            and t4.del_flg = 0
        </if>
        WHERE t1.del_flg = 0
        and t1.company is not null
        and t1.company != ''
        <if test="userId != null and userId != ''">
            and t3.user_id = #{userId}
        </if>
        GROUP BY t1.company
        ORDER BY value
        limit #{limit}
    </select>

</mapper>